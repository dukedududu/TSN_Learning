<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSN æµé‡æ§åˆ¶æ·±åº¦å›¾è§£ (Qbv & Qbu)</title>
    <style>
        :root {
            --bg: #0f111a;
            --panel: #1a1d2d;
            --text: #e0e0e0;
            --primary: #00bcd4;
            --accent: #ff4081;
            --success: #4caf50;
            --warning: #ff9800;
            --line: #2f334d;
            
            --q-crit: #00bcd4; /* å…³é”®æµé¢œè‰² */
            --q-bg: #78909c;   /* èƒŒæ™¯æµé¢œè‰² */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: #14161f;
            border-bottom: 1px solid #333;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            margin-right: 30px;
        }

        .nav-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #aaa;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn.active { 
            color: var(--bg); 
            background: var(--primary); 
            font-weight: bold;
        }

        /* ä¸»ä½“å¸ƒå±€ */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§ç»˜å›¾åŒº */
        .diagram-area {
            flex: 1;
            position: relative;
            background: radial-gradient(#23263a 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å³ä¾§æ§åˆ¶åŒº */
        .control-panel {
            width: 400px;
            background: var(--panel);
            border-left: 1px solid #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .step-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .step-title { font-size: 18px; font-weight: bold; color: var(--primary); }
        .step-counter { font-size: 12px; color: #666; }

        .step-desc {
            font-size: 15px;
            line-height: 1.6;
            color: #ccc;
            flex: 1;
            overflow-y: auto;
        }

        .info-box {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-prev { background: #333; color: #aaa; }
        .btn-next { background: var(--primary); color: #000; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }

        /* SVG æ ·å¼ */
        text { fill: var(--text); font-family: 'Segoe UI', sans-serif; }
        .gate-box { stroke: #555; stroke-width: 2; fill: #1e2230; }
        .queue-box { stroke: #444; stroke-width: 1; fill: none; }
        .packet { rx: 2; stroke: #fff; stroke-width: 0; }
        .timeline { stroke: #333; stroke-width: 2; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #1a1d2d;
            margin: 10% auto; 
            padding: 30px;
            border: 1px solid #444;
            width: 80%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #fff; }
        
        .mnemonic-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        .mnemonic-title { font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block;}
        .mnemonic-tip { color: #ccc; font-size: 14px; }
        .highlight { color: #fff; font-weight: bold; background: rgba(255,255,255,0.1); padding: 0 4px; border-radius: 2px;}

        .btn-help {
            margin-top: 15px;
            background: transparent;
            border: 1px solid #444;
            color: #888;
            font-weight: normal;
        }
        .btn-help:hover {
            border-color: #666;
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

    </style>
</head>
<body>

    <!-- è®°å¿†å°æŠ„æ¨¡æ€æ¡† -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleHelp()">&times;</span>
            <h2 style="margin-top:0; color:var(--text)">ğŸ“ TSN ç¼©å†™é€Ÿè®°æŒ‡å—</h2>
            
            <div class="mnemonic-card" style="border-color: #e91e63">
                <span class="mnemonic-title">ğŸ”¥ åè®®åç§°è®°å¿†æ³• (æ ¸å¿ƒ)</span>
                <div class="mnemonic-tip">
                    â€¢ <b>802.1Qbv</b> (TAS) = <span class="highlight">V</span>IP é€šé“<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šç»™ VIP æµé‡é¢„ç•™ä¸“å±æ—¶é—´ï¼Œé—²äººå›é¿ã€‚<br>
                    â€¢ <b>802.1Qbu</b> (Preemption) = <span class="highlight">U</span>rgent (ç´§æ€¥)<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼š<span class="highlight">U</span>rgent ç´§æ€¥åŒ…å¯ä»¥æ’é˜Ÿã€‚<br>
                    â€¢ <b>802.3br</b> (PHYå±‚) = <span class="highlight">br</span>eak (æ‰“æ–­)<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šåœ¨ç‰©ç†å±‚æŠŠé•¿åŒ…æ‰“æ–­ (<span class="highlight">br</span>eak)ï¼Œé…åˆ Qbu å·¥ä½œã€‚<br>
                    â€¢ <b>802.1Qav</b> (CBS) = <span class="highlight">Av</span>erage (å¹³å‡)<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šæŠŠçªå‘æµé‡æ•´å½¢ä¸ºå¹³å‡é€Ÿç‡ (<span class="highlight">Av</span>erage)ã€‚<br>
                    â€¢ <b>802.1Qci</b> (PSFP) = <span class="highlight">Ci</span>ty Guard (åŸç®¡)<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šåƒåŸç®¡ä¸€æ ·åœ¨å…¥å£ (<span class="highlight">Ci</span>ty Gate) æ£€æŸ¥å’Œè¿‡æ»¤æµé‡ã€‚<br>
                    â€¢ <b>802.1CB</b> (FRER) = <span class="highlight">C</span>opy & <span class="highlight">B</span>ackup<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šå¤åˆ¶ (<span class="highlight">C</span>opy) ä¸€ä»½åšå¤‡ä»½ (<span class="highlight">B</span>ackup) â†’ åŒå‘é€‰æ”¶ã€‚<br>
                    â€¢ <b>802.1AS</b> (gPTP) = <span class="highlight">A</span>ll <span class="highlight">S</span>ync<br>
                      &nbsp;&nbsp;ğŸ‘‰ è®°å¿†ï¼šè®©æ‰€æœ‰ (<span class="highlight">A</span>ll) è®¾å¤‡æ—¶é—´åŒæ­¥ (<span class="highlight">S</span>ync)ã€‚
                </div>
            </div>

            <div class="mnemonic-card" style="border-color: var(--q-bg)">
                <span class="mnemonic-title">MAC ç±»å‹ (è°æ˜¯æ€¥åŒ…ï¼Ÿ)</span>
                <div class="mnemonic-tip">
                    â€¢ <b>pMAC</b> = <span class="highlight">P</span>ause-able (å¯ä»¥æš‚åœçš„) â†’ æ™®é€šæµé‡<br>
                    â€¢ <b>eMAC</b> = <span class="highlight">E</span>xpress (ç‰¹å¿«åˆ—è½¦) â†’ å…³é”®æµé‡
                </div>
            </div>

            <div class="mnemonic-card" style="border-color: var(--warning)">
                <span class="mnemonic-title">SMD å‰ç¼€ (Start Merge Delimiter)</span>
                <div class="mnemonic-tip">
                    â€¢ <b>SMD-S</b> = <span class="highlight">S</span>tart (å¼€å§‹) â†’ åˆ‡ç‰‡çš„ç¬¬ä¸€æ®µ<br>
                    â€¢ <b>SMD-C</b> = <span class="highlight">C</span>ontinue (ç»§ç»­) â†’ åˆ‡ç‰‡çš„åç»­æ®µ<br>
                    â€¢ <b>SMD-E</b> = <span class="highlight">E</span>xpress (ç‰¹å¿«) â†’ å®Œæ•´çš„æ€¥åŒ…
                </div>
            </div>

            <div class="mnemonic-card" style="border-color: var(--success)">
                <span class="mnemonic-title">æ ¡éªŒç  (CRC vs FCS)</span>
                <div class="mnemonic-tip">
                    â€¢ <b>mCRC</b> = <span class="highlight">m</span>iddle (ä¸­é—´çš„) / <span class="highlight">m</span>erge â†’ åˆ‡ç‰‡ç”¨çš„ä¸´æ—¶æ ¡éªŒ<br>
                    â€¢ <b>FCS</b> = <span class="highlight">F</span>inal (æœ€ç»ˆçš„) â†’ æ•´ä¸ªåŒ…ä¼ å®Œçš„æœ€ç»ˆæ ¡éªŒ
                </div>
            </div>
            
            <div style="text-align:center; margin-top:20px; color:#666; font-size:12px;">
                ç‚¹å‡»ä»»æ„å¤„å…³é—­
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="logo">TSN æ·±åº¦å›¾è§£</div>
        <div class="nav-btn active" id="tab-qbv" onclick="switchMode('qbv')">802.1Qbv (TAS)</div>
        <div class="nav-btn" id="tab-qbu" onclick="switchMode('qbu')">802.1Qbu (Preemption)</div>
        <div class="nav-btn" id="tab-qav" onclick="switchMode('qav')">802.1Qav (CBS)</div>
        <div class="nav-btn" id="tab-qci" onclick="switchMode('qci')">802.1Qci (PSFP)</div>
        <div style="flex:1"></div>
        <a href="tsn_control.html" class="nav-btn" style="text-decoration:none; background:#333; color:#fff;">
            â†© è¿”å›æ€»è§ˆ
        </a>
    </div>

    <div class="main-container">
        <div class="diagram-area">
            <svg id="mainSvg" width="800" height="600" viewBox="0 0 800 600">
                <defs>
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#666" />
                    </marker>
                </defs>
                <g id="sceneLayer"></g>
            </svg>
        </div>

        <div class="control-panel">
            <div class="step-card">
                <div class="step-header">
                    <span class="step-title" id="sTitle">åˆå§‹åŒ–</span>
                    <span class="step-counter" id="sCount">0/0</span>
                </div>
                <div class="step-desc" id="sDesc">
                    é€‰æ‹©ä¸Šæ–¹æ ‡ç­¾é¡µå¼€å§‹æ¼”ç¤ºã€‚
                </div>
                <div class="info-box" id="sInfo" style="display:none"></div>
                <div class="btn-group">
                    <button class="btn-prev" id="btnPrev" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn-next" id="btnNext" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
                </div>
                <button class="btn-help" onclick="toggleHelp()">ğŸ’¡ è®°ä¸ä½ç¼©å†™ï¼Ÿç‚¹æˆ‘çœ‹é€Ÿè®°å°æŠ„</button>
            </div>
        </div>
    </div>

    <script>
        // === æ•°æ®å®šä¹‰ ===
        const CONFIG = {
            qbv: {
                title: "802.1Qbv - æ—¶é—´æ„ŸçŸ¥æ•´å½¢ (TAS)",
                steps: [
                    {
                        t: "TAS æ ¸å¿ƒæ¦‚å¿µï¼šé—¨æ§åˆ—è¡¨ (GCL) - ä¹Ÿå°±æ˜¯â€œçº¢ç»¿ç¯æ—¶åˆ»è¡¨â€",
                        d: "æƒ³è±¡ä¸€ä¸ªåå­—è·¯å£ï¼Œ<b>GCL</b> å°±æ˜¯è¿™ä¸ªè·¯å£çš„<b>çº¢ç»¿ç¯æ§åˆ¶ç¨‹åº</b>ã€‚<br><br><ul><li><b>æ™®é€šäº¤æ¢æœºï¼š</b>åƒæ²¡æœ‰çº¢ç»¿ç¯çš„è·¯å£ï¼Œè½¦å­ï¼ˆæ•°æ®åŒ…ï¼‰æŒ¤åœ¨ä¸€èµ·ï¼Œè°æŠ¢åˆ°è°å…ˆèµ°ï¼Œå®¹æ˜“å µè½¦ã€‚</li><li><b>TSN äº¤æ¢æœºï¼š</b>åœ¨æ¯ä¸ªè½¦é“ï¼ˆé˜Ÿåˆ—ï¼‰å‰è£…äº†çº¢ç»¿ç¯ï¼ˆGateï¼‰ã€‚</li><li><b>GCL (æ—¶é—´è¡¨)ï¼š</b>å°±æ˜¯ä¸€å¼ ç²¾ç¡®åˆ°å¾®ç§’çš„æ’ç­è¡¨ï¼Œè§„å®šâ€œç°åœ¨ Q7 ç»¿ç¯ï¼ŒQ0 çº¢ç¯â€ã€‚</li></ul>è¿™æ ·ï¼Œç´§æ€¥è½¦è¾†ï¼ˆå…³é”®æµï¼‰æ°¸è¿œæœ‰ä¸“å±çš„â€œç»¿ç¯æ—¶é—´â€ï¼Œç»å¯¹ä¸ä¼šå µè½¦ã€‚",
                        draw: (ctx) => drawQbvBase(ctx, {g7:0, g0:1, t:0})
                    },
                    {
                        t: "GCL ç¡¬ä»¶å®ç°åŸç†ï¼šå¾ªç¯åˆ—è¡¨",
                        d: "åœ¨èŠ¯ç‰‡å†…éƒ¨ï¼ŒGCL æ˜¯ä¸€ä¸ª<b>å¾ªç¯åˆ—è¡¨ (Circular List)</b>ã€‚<br>åˆ—è¡¨çš„æ¯ä¸€è¡Œï¼ˆEntryï¼‰åŒ…å«ï¼š<br>1. <b>é—¨æ§æ©ç  (Gate States)</b>ï¼šå¦‚ 10000001 (Q7, Q0 å¼€)<br>2. <b>æŒç»­æ—¶é—´ (Time Interval)</b>ï¼šè¯¥çŠ¶æ€ä¿æŒå¤šä¹… (ns)<br><br>ç¡¬ä»¶é€»è¾‘è¯»å–å½“å‰è¡Œï¼Œåº”ç”¨é—¨çŠ¶æ€ï¼Œå€’è®¡æ—¶ç»“æŸåè‡ªåŠ¨è·³åˆ°ä¸‹ä¸€è¡Œã€‚",
                        draw: (ctx) => {
                            // ç”»èƒŒæ™¯
                            drawQbvBase(ctx, {g7:0, g0:1, t:0});
                            
                            // è¦†ç›–ä¸€ä¸ªåŠé€æ˜å±‚ï¼Œèšç„¦åœ¨å³ä¾§
                            ctx.appendChild(createEl("rect", {x:0, y:0, width:800, height:600, fill:"#000", opacity:0.7}));
                            
                            // ç»˜åˆ¶ GCL è¡¨æ ¼ç»“æ„
                            const tableX = 250, tableY = 150;
                            const rowH = 40;
                            const cols = [80, 150, 100]; // Widths: Index, States, Time
                            
                            // è¡¨å¤´
                            ctx.appendChild(createEl("rect", {x:tableX, y:tableY, width:330, height:rowH, fill:"#37474f"}));
                            drawLabel(ctx, tableX+20, tableY+25, "Index", "#fff");
                            drawLabel(ctx, tableX+100, tableY+25, "Gate States", "#fff");
                            drawLabel(ctx, tableX+250, tableY+25, "Time(ns)", "#fff");
                            
                            // æ•°æ®è¡Œ
                            const rows = [
                                {id:0, s:"10000001 (Q0)", t:800, active:true},
                                {id:1, s:"00000000 (All)", t:200, active:false},
                                {id:2, s:"10000000 (Q7)", t:200, active:false},
                                {id:3, s:"10000001 (Q0)", t:800, active:false}
                            ];
                            
                            rows.forEach((r, i) => {
                                const y = tableY + (i+1)*rowH;
                                const color = r.active ? "var(--primary)" : "#546e7a";
                                const bg = r.active ? "rgba(0, 188, 212, 0.2)" : "none";
                                
                                ctx.appendChild(createEl("rect", {x:tableX, y:y, width:330, height:rowH, fill:bg, stroke:"#444"}));
                                drawLabel(ctx, tableX+30, y+25, r.id, "#fff");
                                drawLabel(ctx, tableX+100, y+25, r.s, "#fff");
                                drawLabel(ctx, tableX+260, y+25, r.t, "#fff");
                                
                                if(r.active) {
                                    // æŒ‡é’ˆç®­å¤´
                                    drawArrow(ctx, tableX-50, y+20, tableX-10, y+20, "", "var(--primary)");
                                    drawLabel(ctx, tableX-120, y+25, "Current Ptr", "var(--primary)");
                                }
                            });
                            
                            // å¾ªç¯ç®­å¤´
                            const endY = tableY + (rows.length+1)*rowH;
                            ctx.appendChild(createEl("path", {d:`M ${tableX+165} ${endY} L ${tableX+165} ${endY+20} L ${tableX+350} ${endY+20} L ${tableX+350} ${tableY+rowH/2} L ${tableX+330} ${tableY+rowH/2}`, fill:"none", stroke:"#aaa", "stroke-dasharray":"5,5"}));
                            drawLabel(ctx, tableX+360, tableY+rowH+20, "Loop", "#aaa");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 1: æ™®é€šæµé‡å‘é€",
                        d: "æ—¶é—´ t=0ï¼Œå¤„äºæ™®é€šæ—¶é—´çª—ã€‚<br><b>GCL çŠ¶æ€ï¼š</b>Q7 é—¨å…³ (Closed)ï¼ŒQ0 é—¨å¼€ (Open)ã€‚<br>ä¸€ä¸ªå·¨å¤§çš„èƒŒæ™¯å¸§ (Background Frame) æ­£åœ¨å‘é€ä¸­ã€‚",
                        draw: (ctx) => {
                            drawQbvBase(ctx, {g7:0, g0:1, t:100});
                            // åŠ¨ç”»ï¼šä»å·¦ä¾§è¿›å…¥
                            drawPacket(ctx, 300, 350, 120, 40, "Background", "var(--q-bg)", 1, false, {x:100, y:350}); 
                            drawArrow(ctx, 430, 370, 550, 370, "Sending...");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 2: å…³é”®å¸§åˆ°è¾¾ä½†è¢«é˜»å¡",
                        d: "æ—¶é—´ t=200ï¼Œä¸€ä¸ªç´§æ€¥çš„å…³é”®å¸§ (Critical Frame) åˆ°è¾¾ Q7ã€‚<br>ä½†æ˜¯ï¼æ­¤æ—¶ Q7 çš„é—¨æ˜¯<b>å…³</b>çš„ã€‚<br>å…³é”®å¸§åªèƒ½åœ¨é˜Ÿåˆ—é‡Œæ’é˜Ÿç­‰å¾…ï¼Œä¸èƒ½æ‰“æ–­æ­£åœ¨å‘é€çš„èƒŒæ™¯å¸§ã€‚",
                        draw: (ctx) => {
                            drawQbvBase(ctx, {g7:0, g0:1, t:200});
                            drawPacket(ctx, 300, 350, 100, 40, "Background...", "var(--q-bg)"); // ç»§ç»­å‘
                            // åŠ¨ç”»ï¼šè¿›å…¥é˜Ÿåˆ—
                            drawPacket(ctx, 180, 150, 60, 40, "Critical", "var(--q-crit)", 1, false, {x:50, y:150}); 
                            drawLabel(ctx, 260, 170, "é—¨å…³ç€ï¼Œç­‰å¾…!", "#ff5252");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 3: ä¿æŠ¤å¸¦ (Guard Band)",
                        d: "æ—¶é—´ t=800ï¼Œå³å°†è¿›å…¥å…³é”®æ—¶é—´çª—ã€‚<br>ä¸ºäº†é˜²æ­¢èƒŒæ™¯å¸§â€œæ‹–å ‚â€å ç”¨äº†å…³é”®å¸§çš„æ—¶é—´ï¼ŒTAS ä¼šæå‰å…³é—­ Q0 çš„é—¨ã€‚<br>è¿™å«åš<b>ä¿æŠ¤å¸¦ (Guard Band)</b>ã€‚æ­¤æ—¶ Q0 åœæ­¢å‘é€æ–°åŒ…ã€‚",
                        draw: (ctx) => {
                            drawQbvBase(ctx, {g7:0, g0:0, t:800}); // éƒ½å…³äº†
                            drawLabel(ctx, 260, 370, "Guard Band: æå‰å…³é—¨", "#ff9800");
                            drawPacket(ctx, 180, 150, 60, 40, "Critical", "var(--q-crit)"); // è¿˜åœ¨ç­‰
                        }
                    },
                    {
                        t: "é˜¶æ®µ 4: å…³é”®çª—å£å¼€å¯ (GCL åˆ‡æ¢)",
                        d: "æ—¶é—´ t=1000 (Cycle Start)ã€‚<br><b>GCL åˆ‡æ¢ï¼</b> Q7 é—¨æ‰“å¼€ï¼ŒQ0 ä¿æŒå…³é—­ã€‚<br>å…³é”®å¸§ç«‹å³è·å¾—å‘é€æƒï¼Œæ²¡æœ‰ç«äº‰ï¼Œæ²¡æœ‰å»¶è¿Ÿã€‚",
                        draw: (ctx) => {
                            drawQbvBase(ctx, {g7:1, g0:0, t:1000});
                            // åŠ¨ç”»ï¼šä»é˜Ÿåˆ—å†²å‡ºå»
                            drawPacket(ctx, 300, 150, 60, 40, "Critical", "var(--q-crit)", 1, false, {x:180, y:150}); 
                            drawArrow(ctx, 370, 170, 550, 170, "ç•…é€šæ— é˜»!", "#4caf50");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 5: æ¢å¤æ™®é€šå‘é€",
                        d: "æ—¶é—´ t=1200ï¼Œå…³é”®å¸§å‘å®Œäº†ã€‚<br>GCL å†æ¬¡åˆ‡æ¢ï¼ŒQ7 å…³é—­ï¼ŒQ0 æ‰“å¼€ã€‚<br>èƒŒæ™¯æµç»§ç»­å‘é€ã€‚<br><br><b>æ€»ç»“ï¼š</b>TAS é€šè¿‡æ—¶åˆ†å¤ç”¨ï¼Œä¿è¯äº†å…³é”®æµçš„ç¡®å®šæ€§ä½å»¶è¿Ÿã€‚",
                        draw: (ctx) => {
                            drawQbvBase(ctx, {g7:0, g0:1, t:1200});
                            // åŠ¨ç”»ï¼šå…³é”®å¸§é£èµ°
                            drawPacket(ctx, 550, 150, 60, 40, "Critical", "var(--q-crit)", 0.5, false, {x:300, y:150}); 
                            // åŠ¨ç”»ï¼šæ–°èƒŒæ™¯å¸§è¿›å…¥
                            drawPacket(ctx, 300, 350, 120, 40, "Next Bg Frame", "var(--q-bg)", 1, false, {x:100, y:350}); 
                        }
                    }
                ]
            },
            qbu: {
                title: "802.1Qbu & 802.3br - å¸§æŠ¢å æœºåˆ¶ (Preemption)",
                steps: [
                    {
                        t: "åè®®åˆ†å·¥ï¼š802.1Qbu vs 802.3br",
                        d: "è¿™ä¸¤ä¸ªåè®®é€šå¸¸ä¸€èµ·å·¥ä½œï¼š<br><ul><li><b>802.1Qbu (ä¸Šå±‚ç®¡ç†)ï¼š</b>å†³å®šâ€œè°å¯ä»¥æŠ¢å è°â€ã€‚å®ƒåœ¨ç½‘æ¡¥å±‚å®šä¹‰äº† Express (eMAC) å’Œ Preemptable (pMAC) çš„ä¼˜å…ˆçº§æ˜ å°„ã€‚</li><li><b>802.3br (åº•å±‚æ‰§è¡Œ)ï¼š</b>å®šä¹‰äº†ç‰©ç†å±‚çš„â€œæ‰‹æœ¯åˆ€â€ã€‚å®ƒè´Ÿè´£æŠŠå¸§åˆ‡å¼€ã€æ·»åŠ ç‰¹æ®Šçš„å¸§å¤´ (SMD) å’Œæ ¡éªŒç  (mCRC)ã€‚</li></ul><br><b>MAC Merge Sublayer</b> æ˜¯ 802.3br å¼•å…¥çš„æ–°å±‚ï¼Œä½äº MAC å’Œ PHY ä¹‹é—´ã€‚",
                        draw: (ctx) => drawQbuBase(ctx, {})
                    },
                    {
                        t: "é˜¶æ®µ 1: pMAC å‘é€å®Œæ•´å¸§ (SMD-S)",
                        d: "pMAC å¼€å§‹å‘é€ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„å¤§åŒ…ã€‚<br>æ ¹æ® 802.3brï¼Œæ­£å¸¸å¸§é€šå¸¸ä»¥ <b>SFD</b> (Start Frame Delimiter) å¼€å¤´ã€‚<br>ä½†åœ¨æ”¯æŒæŠ¢å çš„é“¾è·¯ä¸Šï¼Œé¦–ä¸ªåˆ†ç‰‡ï¼ˆæˆ–å®Œæ•´å¸§ï¼‰ä½¿ç”¨ <b>SMD-S (Start)</b> ä½œä¸ºèµ·å§‹ç¬¦ï¼Œå‘Šè¯‰æ¥æ”¶ç«¯â€œè¿™æ˜¯ä¸€ä¸ªå¯è¢«æŠ¢å çš„å¸§â€ã€‚",
                        draw: (ctx) => {
                             drawQbuBase(ctx, {pActive: true});
                             
                             // ç»˜åˆ¶å¸¦ SMD å¤´çš„åŒ…
                             drawPacket(ctx, 400, 400, 200, 30, "[SMD-S] Payload ... [FCS]", "var(--q-bg)", 1, false, {x:100, y:400});
                        }
                    },
                    {
                        t: "é˜¶æ®µ 2: æŠ¢å å‘ç”Ÿ (SMD-S0 + mCRC)",
                        d: "<b>äº‹ä»¶ï¼š</b>eMAC æ¥äº†æ€¥åŒ…ï¼<br><b>802.3br åŠ¨ä½œï¼š</b><br>1. ç«‹å³åœæ­¢å‘é€ pMAC å½“å‰å¸§ã€‚<br>2. ä¿®æ”¹å¸§å°¾ä¸º <b>mCRC</b> (è€Œéæœ€ç»ˆçš„ FCS)ï¼Œè¡¨ç¤ºâ€œæœªå®Œå¾…ç»­â€ã€‚<br>3. è®°å½•å½“å‰çš„åºåˆ—å· (Frame Count)ã€‚<br>æ¥æ”¶ç«¯æ”¶åˆ° mCRCï¼ŒçŸ¥é“è¿™ä¸ªåŒ…è¿˜æ²¡ä¼ å®Œï¼Œæš‚æ—¶å­˜å…¥ <b>Assembly Buffer</b>ã€‚",
                        draw: (ctx) => {
                            drawQbuBase(ctx, {pActive: false, eActive: true});
                            // è¢«åˆ‡æ–­çš„åŒ… (Fragment 1)
                            drawPacket(ctx, 500, 400, 100, 30, "[SMD-S] Frag1 [mCRC]", "var(--q-bg)", 1, true, {x:400, y:400}); 
                            drawLabel(ctx, 400, 440, "CUT! æ·»åŠ  mCRC", "#ff9800");
                            // åŠ¨ç”»ï¼šæ€¥åŒ…è¿›å…¥ eMAC
                            drawPacket(ctx, 150, 200, 80, 30, "Express", "var(--q-crit)", 1, false, {x:50, y:200});
                        }
                    },
                    {
                        t: "é˜¶æ®µ 3: æ’å…¥ Express å¸§ (SMD-E)",
                        d: "é“¾è·¯ç©ºé—²åï¼ŒeMAC å‘é€é«˜ä¼˜å…ˆçº§å¸§ã€‚<br><b>å…³é”®ç‰¹å¾ï¼š</b>è¯¥å¸§ä½¿ç”¨ <b>SMD-E</b> (Express) ä½œä¸ºèµ·å§‹ç¬¦ã€‚<br>æ¥æ”¶ç«¯è¯†åˆ«å‡º SMD-Eï¼ŒçŸ¥é“è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ€¥åŒ…ï¼Œç›´æ¥æ”¾è¡Œï¼Œä¸è¿›å…¥é‡ç»„ç¼“å†²åŒºã€‚",
                        draw: (ctx) => {
                            drawQbuBase(ctx, {pActive: false, eActive: true});
                            // ä¹‹å‰çš„ç¢ç‰‡é£èµ°äº† -> è¿›å…¥ RX Buffer
                            drawPacket(ctx, 600, 160, 60, 30, "Frag 1", "var(--q-bg)", 0.8, true, {x:500, y:400});
                            
                            // åŠ¨ç”»ï¼šæ€¥åŒ…å‘é€
                            drawPacket(ctx, 400, 200, 120, 30, "[SMD-E] Data", "var(--q-crit)", 1, false, {x:150, y:200});
                            drawArrow(ctx, 450, 220, 600, 220, "SMD-E: æ€¥åŒ…ç›´é€š", "#ff5252");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 4: æ¢å¤å‘é€ (SMD-C + FragCnt)",
                        d: "æ€¥åŒ…å‘å®Œï¼Œæ¢å¤ pMAC å‘é€ã€‚<br><b>802.3br åŠ¨ä½œï¼š</b><br>1. å‘é€å‰©ä½™æ•°æ®ç‰‡æ®µã€‚<br>2. ä½¿ç”¨ <b>SMD-C (Continuation)</b> ä½œä¸ºèµ·å§‹ç¬¦ã€‚<br>3. åŒ…å«åˆ†ç‰‡è®¡æ•° (FragCnt) é˜²æ­¢ä¹±åºã€‚<br>æ¥æ”¶ç«¯çœ‹åˆ° SMD-Cï¼Œå°±å»ç¼“å†²åŒºæ‰¾ä¸Šä¸€åŠæ‹¼èµ·æ¥ã€‚",
                        draw: (ctx) => {
                            drawQbuBase(ctx, {pActive: true, eActive: false});
                             // æ€¥åŒ…é£èµ°äº†
                            drawPacket(ctx, 700, 200, 80, 30, "Express", "var(--q-crit)", 0.5, false, {x:400, y:200});
                            // å‰©ä½™éƒ¨åˆ† (Fragment 2)
                            drawPacket(ctx, 400, 400, 140, 30, "[SMD-C] Frag2 [FCS]", "var(--q-bg)", 1, true, {x:150, y:400});
                            drawLabel(ctx, 400, 440, "SMD-C: ç»§ç»­ä¼ è¾“", "#4caf50");
                            
                            // æ¥æ”¶ç«¯çŠ¶æ€
                            drawPacket(ctx, 600, 160, 60, 30, "Frag 1", "var(--q-bg)", 0.5, true); 
                        }
                    },
                    {
                        t: "æ€»ç»“ï¼šSMD ç¼–ç è¡¨",
                        d: "802.3br çš„æ ¸å¿ƒé­”æ³•å°±åœ¨äºæ›¿æ¢äº† SFDï¼š<br><ul><li><b>SMD-E:</b> Express å¸§ï¼Œä¸å¯æŠ¢å ã€‚</li><li><b>SMD-S:</b> Preemptable å¸§çš„å¼€å§‹ (Start)ã€‚</li><li><b>SMD-C:</b> Preemptable å¸§çš„åç»­åˆ†ç‰‡ (Continuation)ã€‚</li></ul>è¿™ä½¿å¾—æ¥æ”¶ç«¯ PHY èƒ½å¤Ÿåœ¨åº•å±‚ç›´æ¥åŒºåˆ†å¸§ç±»å‹ï¼Œæ— éœ€è§£æä¸Šå±‚ Headerã€‚",
                        draw: (ctx) => {
                            drawQbuBase(ctx, {});
                            // å±•ç¤ºä¸‰ä¸ªåŒ…çš„å¯¹æ¯”
                            drawPacket(ctx, 350, 150, 150, 30, "[SMD-E] Express", "var(--q-crit)", 1);
                            drawPacket(ctx, 350, 250, 150, 30, "[SMD-S] Start...", "var(--q-bg)", 1, true);
                            drawPacket(ctx, 350, 350, 150, 30, "[SMD-C] ...Continue", "var(--q-bg)", 1, true);
                        }
                    }
                ]
            },
            qav: {
                title: "802.1Qav - åŸºäºä¿¡ç”¨çš„æ•´å½¢ (CBS)",
                steps: [
                    {
                        t: "æ ¸å¿ƒæ¦‚å¿µï¼šä¿¡ç”¨ç§¯åˆ† (Credit)",
                        d: "CBS (Credit Based Shaper) å°±åƒä¿¡ç”¨å¡çš„é¢åº¦ç®¡ç†ã€‚<br>1. <b>å‘é€æ•°æ®</b>éœ€è¦æ¶ˆè€—ä¿¡ç”¨ï¼ˆæ‰£åˆ†ï¼‰ã€‚<br>2. <b>ç­‰å¾…æœŸé—´</b>ä¼šæ¢å¤ä¿¡ç”¨ï¼ˆåŠ åˆ†ï¼‰ã€‚<br>3. åªæœ‰ä¿¡ç”¨ >= 0 æ—¶æ‰å…è®¸å‘é€ã€‚<br>è¿™èƒ½é˜²æ­¢çªå‘æµé‡ç¬é—´æ·¹æ²¡ç½‘ç»œï¼ŒæŠŠâ€œä¸€æ³¢æµâ€å¹³æ»‘æˆâ€œç»†æ°´é•¿æµâ€ã€‚",
                        draw: (ctx) => drawQavBase(ctx, {credit: 0, sending: false})
                    },
                    {
                        t: "é˜¶æ®µ 1: ç§¯ç´¯ä¿¡ç”¨ (Idle Slope)",
                        d: "é˜Ÿåˆ—ä¸­æœ‰åŒ…åœ¨ç­‰å¾…ï¼Œä½†å½“å‰ä¿¡ç”¨ä¸ºè´Ÿï¼ˆä¾‹å¦‚ -50ï¼‰ã€‚<br>æ­¤æ—¶å¿…é¡»ç­‰å¾…ã€‚<br>éšç€æ—¶é—´æ¨ç§»ï¼Œä¿¡ç”¨ä»¥ <b>IdleSlope</b> çš„é€Ÿç‡çº¿æ€§å¢é•¿ã€‚<br>è¿™æ˜¯ä¸€ä¸ªâ€œæ”’äººå“â€çš„è¿‡ç¨‹ã€‚",
                        draw: (ctx) => {
                            drawQavBase(ctx, {credit: -50, sending: false});
                            drawPacket(ctx, 150, 230, 80, 40, "Packet A", "var(--q-crit)");
                            drawArrow(ctx, 400, 300, 400, 200, "Credit å¢åŠ ", "var(--success)");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 2: ä¿¡ç”¨è½¬æ­£ï¼Œå¼€å§‹å‘é€",
                        d: "ä¿¡ç”¨ç»ˆäºæ¶¨åˆ°äº† 0ï¼<br>é—¸é—¨æ‰“å¼€ï¼Œæ•°æ®åŒ…å¼€å§‹å‘é€ã€‚<br>åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œä¿¡ç”¨ä¼šä»¥ <b>SendSlope</b> çš„é€Ÿç‡è¿…é€Ÿä¸‹é™ï¼ˆæ‰£åˆ†ï¼‰ã€‚",
                        draw: (ctx) => {
                            drawQavBase(ctx, {credit: 0, sending: true});
                            drawPacket(ctx, 400, 230, 80, 40, "Packet A", "var(--q-crit)", 1, false, {x:150, y:230});
                            drawArrow(ctx, 400, 200, 400, 300, "Credit ä¸‹é™", "#f44336");
                        }
                    },
                    {
                        t: "é˜¶æ®µ 3: å‘é€ç»“æŸï¼Œä¿¡ç”¨é€æ”¯",
                        d: "åŒ…å‘å®Œäº†ï¼Œæ­¤æ—¶ä¿¡ç”¨å˜æˆäº†è´Ÿæ•°ï¼ˆä¾‹å¦‚ -80ï¼‰ã€‚<br>ç³»ç»Ÿè¿›å…¥â€œè¿˜å€ºâ€æ¨¡å¼ã€‚<br>ä¸‹ä¸€ä¸ªåŒ…å¿…é¡»ç­‰å¾…ä¿¡ç”¨é‡æ–°æ¶¨å› 0 æ‰èƒ½å‘é€ã€‚<br>é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå¼ºåˆ¶æ‹‰å¼€äº†åŒ…ä¸åŒ…ä¹‹é—´çš„é—´éš”ã€‚",
                        draw: (ctx) => {
                            drawQavBase(ctx, {credit: -80, sending: false});
                            drawPacket(ctx, 650, 230, 80, 40, "Packet A", "var(--q-crit)", 0.5, false, {x:400, y:230});
                            drawPacket(ctx, 150, 230, 80, 40, "Packet B", "var(--q-crit)", 1, false, {x:50, y:230});
                            drawLabel(ctx, 350, 260, "Stop! ä¿¡ç”¨ä¸è¶³", "#f44336");
                        }
                    }
                ]
            },
            qci: {
                title: "802.1Qci - æµé‡è¿‡æ»¤ä¸ç›‘ç®¡ (PSFP) æµæ°´çº¿æ¼”ç¤º",
                steps: [
                    {
                        t: "æµæ°´çº¿å°±ç»ª",
                        d: "è¿™æ˜¯ä¸€ä¸ª PSFP å¤„ç†æµæ°´çº¿ï¼Œç±»ä¼¼äºå·¥å‚çš„è´¨æ£€ä¼ é€å¸¦ã€‚<br>æ‰€æœ‰è¿›å…¥äº¤æ¢æœºçš„æµé‡éƒ½è¦ä¾æ¬¡ç»è¿‡ä¸‰é“å…³å¡ï¼š<br>1. <b>Filter</b> (è¯†åˆ«èº«ä»½)<br>2. <b>Gate</b> (æ£€æŸ¥æ—¶é—´)<br>3. <b>Meter</b> (æ£€æŸ¥æµé€Ÿ)",
                        draw: (ctx) => drawQciScene(ctx, {})
                    },
                    {
                        t: "1. æŠ¥æ–‡åˆ°è¾¾ (Ingress)",
                        d: "ä¸€ä¸ª VLAN 100 çš„æ•°æ®åŒ…åˆ°è¾¾ç«¯å£ã€‚<br>å‡†å¤‡è¿›å…¥å¤„ç†æµç¨‹ã€‚",
                        draw: (ctx) => {
                            drawQciScene(ctx, {});
                            // åŠ¨ç”»ï¼šä»å·¦å¤–ä¾§(-100) è¿›å…¥åˆ° Filter å‰(50)
                            drawPacket(ctx, 50, 280, 80, 40, "VLAN 100", "var(--primary)", 1, false, {x: -100, y: 280});
                        }
                    },
                    {
                        t: "2. Stream Filter (èº«ä»½è¯†åˆ«)",
                        d: "äº¤æ¢æœºæŸ¥æ‰¾è¿‡æ»¤è¡¨ã€‚<br>è§„åˆ™ï¼šVLAN 100 = Stream Aã€‚<br><b>Match!</b> è¯†åˆ«æˆåŠŸï¼Œè¯¥æµè¢«å…³è”åˆ° Gate 1 å’Œ Meter 1ã€‚",
                        draw: (ctx) => {
                            drawQciScene(ctx, {active: 'filter'});
                            // åŠ¨ç”»ï¼šä»å…¥å£(50) -> Filter(150)
                            drawPacket(ctx, 150, 280, 80, 40, "Stream A", "var(--primary)", 1, false, {x: 50, y: 280});
                            drawLabel(ctx, 150, 220, "Match: Stream A", "var(--success)");
                        }
                    },
                    {
                        t: "3. Stream Gate (æ—¶é—´æ£€æŸ¥)",
                        d: "æ£€æŸ¥ Gate 1 çš„çŠ¶æ€ã€‚<br>å½“å‰æ—¶é—´çª—å£ï¼š<b>OPEN (ç»¿ç¯)</b>ã€‚<br>å…è®¸é€šè¡Œï¼",
                        draw: (ctx) => {
                            drawQciScene(ctx, {active: 'gate', gate: 'open'});
                            // åŠ¨ç”»ï¼šFilter(150) -> Gate(350)
                            drawPacket(ctx, 350, 280, 80, 40, "Stream A", "var(--primary)", 1, false, {x: 150, y: 280});
                            drawLabel(ctx, 350, 220, "Gate: OPEN", "var(--success)");
                        }
                    },
                    {
                        t: "4. Flow Meter (æµé‡è®¡è´¹)",
                        d: "æ£€æŸ¥ä»¤ç‰Œæ¡¶ä½™é¢ã€‚<br>ä½™é¢å……è¶³ï¼Œæ‰£é™¤ 100 ç§¯åˆ†ã€‚<br>æœªè¶…é€Ÿï¼Œæ”¾è¡Œï¼",
                        draw: (ctx) => {
                            drawQciScene(ctx, {active: 'meter', gate: 'open', meter: 'ok'});
                            // åŠ¨ç”»ï¼šGate(350) -> Meter(550)
                            drawPacket(ctx, 550, 280, 80, 40, "Stream A", "var(--primary)", 1, false, {x: 350, y: 280});
                            drawLabel(ctx, 550, 220, "Token OK (-100)", "var(--success)");
                        }
                    },
                    {
                        t: "5. å®Œæˆè½¬å‘",
                        d: "æŠ¥æ–‡é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œè¿›å…¥äº¤æ¢çŸ©é˜µè¿›è¡Œè½¬å‘ã€‚",
                        draw: (ctx) => {
                            drawQciScene(ctx, {gate: 'open', meter: 'ok'}); // åŒ…é£èµ°äº†
                            // åŠ¨ç”»ï¼šMeter(550) -> Out(800)
                            drawPacket(ctx, 800, 280, 80, 40, "Stream A", "var(--primary)", 0.5, false, {x: 550, y: 280});
                            drawLabel(ctx, 700, 220, "Forwarding...", "var(--success)");
                        }
                    },
                    {
                        t: "Meter 1 å†…éƒ¨åŸç†ï¼šä»¤ç‰Œæ¡¶ç®—æ³• (Token Bucket)",
                        d: "ä¸ºäº†ç²¾ç¡®é™é€Ÿï¼ŒTSN ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚<br>1. <b>æ³¨å…¥ (CIR)ï¼š</b>ç³»ç»Ÿä»¥æ’å®šé€Ÿç‡ï¼ˆå¦‚ 100Mbpsï¼‰å‘æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œã€‚<br>2. <b>å®¹é‡ (CBS)ï¼š</b>æ¡¶çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œæ»¡äº†æº¢å‡ºï¼ˆä¸èƒ½æ— é™å­˜ï¼‰ã€‚<br>3. <b>æ¶ˆè€—ï¼š</b>æ¯è½¬å‘ 1 bit æ•°æ®ï¼Œå°±å¿…é¡»æ¶ˆè€— 1 bit ä»¤ç‰Œã€‚<br><b>ç»“è®ºï¼š</b>æœ‰ä»¤ç‰Œæ‰èƒ½å‘ï¼Œæ²¡ä»¤ç‰Œåªèƒ½ä¸¢ï¼ˆæˆ–æ ‡è®°å˜çº¢ï¼‰ã€‚",
                        draw: (ctx) => {
                            // ç”»èƒŒæ™¯
                            drawQciScene(ctx, {active: 'meter', gate: 'open', meter: 'ok'});
                            
                            // é®ç½©å±‚
                            ctx.appendChild(createEl("rect", {x:0, y:0, width:800, height:600, fill:"#000", opacity:0.8}));
                            
                            // ç»˜åˆ¶æ”¾å¤§çš„ä»¤ç‰Œæ¡¶
                            const bX = 400, bY = 300;
                            const bW = 150, bH = 200;
                            
                            // æ¡¶èº«
                            ctx.appendChild(createEl("path", {d:`M ${bX-bW/2} ${bY-bH/2} L ${bX-bW/2} ${bY+bH/2} L ${bX+bW/2} ${bY+bH/2} L ${bX+bW/2} ${bY-bH/2}`, fill:"none", stroke:"#fff", "stroke-width":4}));
                            
                            // æ°´é¾™å¤´ (CIR)
                            const tapX = bX - bW/2 - 40;
                            ctx.appendChild(createEl("path", {d:`M ${tapX} ${bY-bH/2-50} L ${bX} ${bY-bH/2-50} L ${bX} ${bY-bH/2-10}`, fill:"none", stroke:"var(--success)", "stroke-width":6}));
                            ctx.appendChild(createEl("circle", {cx:tapX, cy:bY-bH/2-50, r:10, fill:"#555"})); // é˜€é—¨
                            drawLabel(ctx, tapX, bY-bH/2-70, "CIR (æ³¨å…¥é€Ÿç‡)", "var(--success)");
                            
                            // æ»´æ°´åŠ¨ç”» (Tokens)
                            for(let i=0; i<3; i++) {
                                const drop = createEl("circle", {cx:bX, cy:bY-bH/2+20 + i*30, r:6, fill:"var(--warning)"});
                                drop.appendChild(createEl("animate", {attributeName:"cy", from:bY-bH/2-10, to:bY+bH/2-20, dur:"1.5s", begin:`${i*0.5}s`, repeatCount:"indefinite"}));
                                ctx.appendChild(drop);
                            }
                            
                            // æ°´ä½ (CBS)
                            ctx.appendChild(createEl("rect", {x:bX-bW/2+5, y:bY, width:bW-10, height:bH/2, fill:"var(--warning)", opacity:0.5}));
                            drawLabel(ctx, bX, bY+bH/4, "Tokens (Credits)", "#fff");
                            
                            // CBS æ ‡æ³¨
                            drawArrow(ctx, bX+bW/2+10, bY-bH/2, bX+bW/2+10, bY+bH/2, "", "#aaa");
                            drawLabel(ctx, bX+bW/2+60, bY, "CBS (æ¡¶æ·±)", "#aaa");
                            
                            // æ¶ˆè€— (Packet)
                            drawArrow(ctx, bX, bY+bH/2+10, bX, bY+bH/2+60, "æ¶ˆè€—ä»¤ç‰Œ", "#f44336");
                            drawPacket(ctx, bX-40, bY+bH/2+70, 80, 40, "Packet", "var(--primary)");
                        }
                    },
                    {
                        t: "å¼‚å¸¸åœºæ™¯æ¼”ç¤ºï¼šGate å…³é—­",
                        d: "ç°åœ¨æ¨¡æ‹Ÿå¦ä¸€ä¸ªåœºæ™¯ã€‚<br>å‡è®¾æŠ¥æ–‡åœ¨<b>é”™è¯¯çš„æ—¶é—´</b>åˆ°è¾¾ã€‚<br>æ­¤æ—¶ Gate çŠ¶æ€ä¸º <b>CLOSED (çº¢ç¯)</b>ã€‚",
                        draw: (ctx) => {
                             drawQciScene(ctx, {active: 'gate', gate: 'closed'});
                             // åŠ¨ç”»ï¼šFilter(150) -> Gate(350)
                             drawPacket(ctx, 350, 280, 80, 40, "Stream B", "#f44336", 1, false, {x: 150, y: 280});
                             drawLabel(ctx, 350, 220, "Gate CLOSED!", "#f44336");
                        }
                    },
                    {
                        t: "ä¸¢å¼ƒå¤„ç† (Drop)",
                        d: "å› ä¸º Gate å…³é—­ï¼ŒæŠ¥æ–‡è¢«ç«‹å³ä¸¢å¼ƒã€‚<br>å®ƒå°±åƒæ’ä¸Šäº†ä¸€å µå¢™ï¼Œä¸ä¼šè¿›å…¥åç»­çš„ Meter æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šå ç”¨åç»­å¸¦å®½ã€‚",
                        draw: (ctx) => {
                             drawQciScene(ctx, {gate: 'closed'});
                             // åŠ¨ç”»ï¼šGate(350) -> ä¸‹æ–¹æ¶ˆå¤±
                             drawPacket(ctx, 350, 450, 80, 40, "DROPPED", "#f44336", 0, false, {x: 350, y: 280});
                        }
                    }
                ]
            }
        };

        // === çŠ¶æ€ç®¡ç† ===
        let currentMode = 'qbv';
        let stepIndex = 0;
        const svgLayer = document.getElementById('sceneLayer');

        function switchMode(mode) {
            currentMode = mode;
            stepIndex = 0;
            
            // æ›´æ–°å¯¼èˆªæ æ ·å¼
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            renderStep();
        }

        function nextStep() {
            const max = CONFIG[currentMode].steps.length - 1;
            if (stepIndex < max) {
                stepIndex++;
                renderStep();
            }
        }

        function prevStep() {
            if (stepIndex > 0) {
                stepIndex--;
                renderStep();
            }
        }

        // è®°å¿†å°æŠ„å¼€å…³
        function toggleHelp() {
            const m = document.getElementById('helpModal');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('helpModal').onclick = function(e) {
            if(e.target === this) toggleHelp();
        }

        function renderStep() {
            const data = CONFIG[currentMode].steps[stepIndex];
            const total = CONFIG[currentMode].steps.length;

            // æ›´æ–°æ–‡æœ¬
            document.getElementById('sTitle').innerHTML = data.t;
            document.getElementById('sCount').innerText = `${stepIndex + 1}/${total}`;
            document.getElementById('sDesc').innerHTML = data.d;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('btnPrev').disabled = (stepIndex === 0);
            document.getElementById('btnNext').disabled = (stepIndex === total - 1);

            // æ¸…ç©º SVG å¹¶é‡ç»˜
            svgLayer.innerHTML = '';
            data.draw(svgLayer);
        }

        // === SVG ç»˜å›¾è¾…åŠ©å‡½æ•° ===
        
        // åˆ›å»º SVG å…ƒç´ 
        function createEl(type, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", type);
            for (let k in attrs) el.setAttribute(k, attrs[k]);
            return el;
        }

        // ç»˜åˆ¶ Qbv åŸºç¡€åœºæ™¯ (é˜Ÿåˆ— + é—¨ + GCLæ—¶é—´è½´)
        function drawQbvBase(parent, state) { // state: {g7: 0/1, g0: 0/1, t: int}
            // 1. ç»˜åˆ¶ç«¯å£ç»“æ„
            // Q7 (ä¸Š)
            parent.appendChild(createEl("rect", {x:100, y:130, width:150, height:60, class:"queue-box"}));
            const t7 = createEl("text", {x:110, y:120, fill:"var(--q-crit)", "font-size":14, "font-weight":"bold"});
            t7.textContent = "Q7: Critical (å…³é”®æµ)";
            parent.appendChild(t7);
            
            // Q0 (ä¸‹)
            parent.appendChild(createEl("rect", {x:100, y:330, width:150, height:60, class:"queue-box"}));
            const t0 = createEl("text", {x:110, y:320, fill:"var(--q-bg)", "font-size":14, "font-weight":"bold"});
            t0.textContent = "Q0: Best Effort (èƒŒæ™¯æµ)";
            parent.appendChild(t0);

            // 2. ç»˜åˆ¶é—¨ (Gate)
            const drawGate = (x, y, open, label) => {
                const color = open ? "var(--success)" : "#f44336";
                // é—¨æ¡†èƒŒæ™¯
                parent.appendChild(createEl("circle", {cx:x, cy:y, r:18, stroke:color, "stroke-width":2, fill:"#14161f"}));
                // çŠ¶æ€å›¾æ ‡
                if(open) {
                    // å¼€ï¼šç«–çº¿é€šè¿‡
                    parent.appendChild(createEl("line", {x1:x, y1:y-10, x2:x, y2:y+10, stroke:color, "stroke-width":4}));
                    parent.appendChild(createEl("path", {d:`M ${x-5} ${y-5} L ${x+5} ${y} L ${x-5} ${y+5}`, fill:color})); // ç®­å¤´
                } else {
                    // å…³ï¼šXå·
                    parent.appendChild(createEl("line", {x1:x-8, y1:y-8, x2:x+8, y2:y+8, stroke:color, "stroke-width":4}));
                    parent.appendChild(createEl("line", {x1:x+8, y1:y-8, x2:x-8, y2:y+8, stroke:color, "stroke-width":4}));
                }
                // æ ‡ç­¾
                const t1 = createEl("text", {x:x, y:y-25, "text-anchor":"middle", fill:color, "font-weight":"bold", "font-size":12});
                t1.textContent = open ? "OPEN" : "CLOSED";
                parent.appendChild(t1);
                
                const t2 = createEl("text", {x:x, y:y+35, "text-anchor":"middle", fill:"#aaa", "font-size":10});
                t2.textContent = label;
                parent.appendChild(t2);
            };

            drawGate(280, 160, state.g7, "Gate 7");
            drawGate(280, 360, state.g0, "Gate 0");

            // 3. èšåˆå™¨ (Multiplexer)
            parent.appendChild(createEl("path", {d:"M 310 160 L 380 260 L 310 360", fill:"none", stroke:"#555", "stroke-width":2, "stroke-dasharray":"5,5"}));
            parent.appendChild(createEl("line", {x1:380, y1:260, x2:750, y2:260, stroke:"#444", "stroke-width":6})); // Output Link
            const tPhy = createEl("text", {x:700, y:240, fill:"#aaa", "font-size":12});
            tPhy.textContent = "Ethernet PHY (Output)";
            parent.appendChild(tPhy);

            // 4. GCL æ—¶é—´è½´ (å¯è§†åŒ–å¢å¼º)
            const timelineY = 60;
            const width = 700;
            const startX = 50;
            
            // ç»˜åˆ¶æ—¶é—´æ¡èƒŒæ™¯
            // 0-800: Normal (Q0 Open)
            parent.appendChild(createEl("rect", {x:startX, y:timelineY, width:width*0.4, height:15, fill:"#263238"}));
            const tNormal = createEl("text", {x:startX+10, y:timelineY-5, fill:"#aaa", "font-size":10});
            tNormal.textContent = "Normal Window";
            parent.appendChild(tNormal);
            
            // 800-1000: Guard Band (All Closed)
            parent.appendChild(createEl("rect", {x:startX+width*0.4, y:timelineY, width:width*0.1, height:15, fill:"#ff9800"}));
            const tGuard = createEl("text", {x:startX+width*0.4, y:timelineY-5, fill:"#ff9800", "font-size":10});
            tGuard.textContent = "Guard Band";
            parent.appendChild(tGuard);
            
            // 1000-1200: Critical (Q7 Open)
            parent.appendChild(createEl("rect", {x:startX+width*0.5, y:timelineY, width:width*0.1, height:15, fill:"rgba(0, 188, 212, 0.3)"}));
            const tCrit = createEl("text", {x:startX+width*0.5, y:timelineY-5, fill:"var(--primary)", "font-size":10});
            tCrit.textContent = "Critical Window";
            parent.appendChild(tCrit);
            
            // 1200-2000: Normal
            parent.appendChild(createEl("rect", {x:startX+width*0.6, y:timelineY, width:width*0.4, height:15, fill:"#263238"}));

            // æ¸¸æ ‡
            const curX = startX + (state.t/2000)*width;
            parent.appendChild(createEl("line", {x1:curX, y1:timelineY-10, x2:curX, y2:timelineY+25, stroke:"#fff", "stroke-width":2}));
            parent.appendChild(createEl("polygon", {points:`${curX-5},${timelineY-10} ${curX+5},${timelineY-10} ${curX},${timelineY}`, fill:"#fff"}));
            const tTime = createEl("text", {x:curX, y:timelineY+40, "text-anchor":"middle", fill:"#fff", "font-size":12, "font-weight":"bold"});
            tTime.textContent = `t=${state.t}Î¼s`;
            parent.appendChild(tTime);
        }

        // ç»˜åˆ¶ Qbu åŸºç¡€åœºæ™¯ (å‘é€ç«¯ + æ¥æ”¶ç«¯ + ç¢ç‰‡é‡ç»„)
        function drawQbuBase(parent, state) {
            // å‘é€ç«¯ (Sender)
            const txX = 50;
            
            // eMAC
            parent.appendChild(createEl("rect", {x:txX, y:150, width:100, height:50, fill:"#1e2230", stroke:"var(--q-crit)", "stroke-width":2, rx:4}));
            const tEmac = createEl("text", {x:txX+50, y:180, "text-anchor":"middle", fill:"var(--q-crit)", "font-weight":"bold"});
            tEmac.textContent = "eMAC (Express)";
            parent.appendChild(tEmac);

            // pMAC
            parent.appendChild(createEl("rect", {x:txX, y:350, width:100, height:50, fill:"#1e2230", stroke:"var(--q-bg)", "stroke-width":2, rx:4}));
            const tPmac = createEl("text", {x:txX+50, y:380, "text-anchor":"middle", fill:"var(--q-bg)", "font-weight":"bold"});
            tPmac.textContent = "pMAC (Standard)";
            parent.appendChild(tPmac);

            // MAC Merge (Sender)
            parent.appendChild(createEl("rect", {x:txX+150, y:100, width:60, height:350, rx:10, fill:"#263238", stroke:"#aaa", "stroke-width":2}));
            const tMergeTx = createEl("text", {x:txX+180, y:250, "text-anchor":"middle", fill:"#fff", "font-weight":"bold", "writing-mode":"tb"});
            tMergeTx.textContent = "MAC Merge (TX)";
            parent.appendChild(tMergeTx);

            // è¿æ¥çº¿
            parent.appendChild(createEl("path", {d:`M ${txX+100} 175 L ${txX+150} 175`, stroke:"var(--q-crit)", "stroke-width":2}));
            parent.appendChild(createEl("path", {d:`M ${txX+100} 375 L ${txX+150} 375`, stroke:"var(--q-bg)", "stroke-width":2}));

            // ç‰©ç†é“¾è·¯
            parent.appendChild(createEl("line", {x1:txX+210, y1:275, x2:550, y2:275, stroke:"#555", "stroke-width":4}));
            
            // æ¥æ”¶ç«¯ (Receiver)
            const rxX = 550;
            parent.appendChild(createEl("rect", {x:rxX, y:100, width:60, height:350, rx:10, fill:"#263238", stroke:"#aaa", "stroke-width":2}));
            const tMergeRx = createEl("text", {x:rxX+30, y:250, "text-anchor":"middle", fill:"#fff", "font-weight":"bold", "writing-mode":"tb"});
            tMergeRx.textContent = "MAC Merge (RX)";
            parent.appendChild(tMergeRx);
            
            // æ¥æ”¶ç¼“å†²åŒºç¤ºæ„
            parent.appendChild(createEl("rect", {x:rxX+80, y:150, width:80, height:50, class:"queue-box", "stroke-dasharray":"2,2"}));
            const tBuf = createEl("text", {x:rxX+120, y:140, "text-anchor":"middle", fill:"#aaa", "font-size":10});
            tBuf.textContent = "Assembly Buf";
            parent.appendChild(tBuf);

            // çŠ¶æ€æŒ‡ç¤º
            if(state.eActive) {
                parent.appendChild(createEl("circle", {cx:txX+180, cy:175, r:6, fill:"var(--success)"}));
            }
            if(state.pActive) {
                parent.appendChild(createEl("circle", {cx:txX+180, cy:375, r:6, fill:"var(--success)"}));
            }
        }

        // ç»˜åˆ¶ Qav åŸºç¡€åœºæ™¯ (ä¿¡ç”¨æ¡¶)
        function drawQavBase(parent, state) {
            // 1. é˜Ÿåˆ—
            parent.appendChild(createEl("rect", {x:100, y:200, width:150, height:60, class:"queue-box"}));
            const tQ = createEl("text", {x:110, y:190, fill:"var(--q-crit)", "font-size":14, "font-weight":"bold"});
            tQ.textContent = "Queue A (Class A)";
            parent.appendChild(tQ);

            // 2. é—¨ (Gate) - å—ä¿¡ç”¨æ§åˆ¶
            const gateColor = (state.credit >= 0) ? "var(--success)" : "#f44336";
            parent.appendChild(createEl("circle", {cx:280, cy:230, r:18, stroke:gateColor, "stroke-width":2, fill:"#14161f"}));
            if(state.credit >= 0) {
                 parent.appendChild(createEl("line", {x1:280, y1:220, x2:280, y2:240, stroke:gateColor, "stroke-width":4}));
            } else {
                 parent.appendChild(createEl("line", {x1:272, y1:222, x2:288, y2:238, stroke:gateColor, "stroke-width":4}));
                 parent.appendChild(createEl("line", {x1:288, y1:222, x2:272, y2:238, stroke:gateColor, "stroke-width":4}));
            }

            // 3. ä¿¡ç”¨æ¡¶å¯è§†åŒ–
            const bucketX = 400;
            const bucketY = 250;
            // åæ ‡è½´
            parent.appendChild(createEl("line", {x1:bucketX, y1:150, x2:bucketX, y2:350, stroke:"#555"})); // Yè½´
            parent.appendChild(createEl("line", {x1:bucketX-50, y1:250, x2:bucketX+50, y2:250, stroke:"#888", "stroke-dasharray":"2,2"})); // 0è½´
            
            // ä¿¡ç”¨æŸ±çŠ¶å›¾
            const barH = Math.abs(state.credit);
            const barY = (state.credit >= 0) ? (250 - barH) : 250;
            const barColor = (state.credit >= 0) ? "var(--success)" : "#f44336";
            
            parent.appendChild(createEl("rect", {x:bucketX-20, y:barY, width:40, height:barH, fill:barColor, opacity:0.8}));
            
            const tCredit = createEl("text", {x:bucketX+30, y:barY + barH/2 + 5, fill:"#fff", "font-weight":"bold"});
            tCredit.textContent = `Credit: ${state.credit}`;
            parent.appendChild(tCredit);

            // 4. å‡ºå£
            parent.appendChild(createEl("line", {x1:300, y1:230, x2:600, y2:230, stroke:"#444", "stroke-width":6}));
            const tPhy = createEl("text", {x:550, y:210, fill:"#aaa", "font-size":12});
            tPhy.textContent = "Output";
            parent.appendChild(tPhy);
        }

        // ç»˜åˆ¶ Qci åŠ¨æ€åœºæ™¯ (ç±»ä¼¼ Qbv çš„é£æ ¼)
        function drawQciScene(parent, state) {
            // state: { active: 'filter'|'gate'|'meter', gate: 'open'|'closed', meter: 'ok'|'empty' }
            const y = 280;
            
            // æ¨¡å—åæ ‡
            const fX = 150, gX = 350, mX = 550;
            
            // 0. ç»˜åˆ¶è¿æ¥çº¿ (èƒŒæ™¯)
            parent.appendChild(createEl("line", {x1:50, y1:y, x2:750, y2:y, stroke:"#444", "stroke-width":2}));

            // 1. Stream Filter
            const fColor = state.active === 'filter' ? "var(--primary)" : "#666";
            const fStroke = state.active === 'filter' ? 3 : 1;
            parent.appendChild(createEl("rect", {x:fX-50, y:y-40, width:100, height:80, fill:"#1e2230", stroke:fColor, "stroke-width":fStroke, rx:4}));
            const tF = createEl("text", {x:fX, y:y+55, "text-anchor":"middle", fill:fColor, "font-size":12, "font-weight":"bold"});
            tF.textContent = "Filter";
            parent.appendChild(tF);
            // å†…éƒ¨å›¾æ ‡ (åˆ—è¡¨)
            parent.appendChild(createEl("rect", {x:fX-30, y:y-20, width:60, height:10, fill:"#555"}));
            parent.appendChild(createEl("rect", {x:fX-30, y:y, width:60, height:10, fill:"#555"}));

            // 2. Stream Gate
            const gColor = state.active === 'gate' ? "var(--primary)" : "#666";
            const gStroke = state.active === 'gate' ? 3 : 1;
            parent.appendChild(createEl("rect", {x:gX-50, y:y-40, width:100, height:80, fill:"#1e2230", stroke:gColor, "stroke-width":gStroke, rx:4}));
            const tG = createEl("text", {x:gX, y:y+55, "text-anchor":"middle", fill:gColor, "font-size":12, "font-weight":"bold"});
            tG.textContent = "Gate";
            parent.appendChild(tG);
            
            // å†…éƒ¨å›¾æ ‡ (å¼€å…³)
            const gateOpen = state.gate !== 'closed'; // é»˜è®¤ open
            const iconColor = gateOpen ? "var(--success)" : "#f44336";
            if(gateOpen) {
                // ç»¿è‰²ç«–çº¿
                parent.appendChild(createEl("line", {x1:gX, y1:y-25, x2:gX, y2:y+25, stroke:iconColor, "stroke-width":6}));
            } else {
                // çº¢è‰²æ¨ªçº¿ (é˜»æ–­)
                parent.appendChild(createEl("line", {x1:gX-25, y1:y, x2:gX+25, y2:y, stroke:iconColor, "stroke-width":6}));
            }

            // 3. Flow Meter
            const mColor = state.active === 'meter' ? "var(--primary)" : "#666";
            const mStroke = state.active === 'meter' ? 3 : 1;
            parent.appendChild(createEl("rect", {x:mX-50, y:y-40, width:100, height:80, fill:"#1e2230", stroke:mColor, "stroke-width":mStroke, rx:4}));
            const tM = createEl("text", {x:mX, y:y+55, "text-anchor":"middle", fill:mColor, "font-size":12, "font-weight":"bold"});
            tM.textContent = "Meter";
            parent.appendChild(tM);
            // å†…éƒ¨å›¾æ ‡ (æ¡¶)
            parent.appendChild(createEl("path", {d:`M ${mX-20} ${y-20} L ${mX-20} ${y+20} L ${mX+20} ${y+20} L ${mX+20} ${y-20}`, fill:"none", stroke:"var(--warning)", "stroke-width":2}));
            const waterH = state.meter === 'empty' ? 5 : 30;
            const waterC = state.meter === 'empty' ? "#f44336" : "var(--warning)";
            parent.appendChild(createEl("rect", {x:mX-18, y:y+20-waterH, width:36, height:waterH, fill:waterC, opacity:0.6}));
            
            // 4. æ–¹å‘ç®­å¤´ (è£…é¥°)
            drawArrow(parent, 50, y, 100, y);
            drawArrow(parent, 200, y, 300, y);
            drawArrow(parent, 400, y, 500, y);
            drawArrow(parent, 600, y, 700, y);
        }

        // é€šç”¨ï¼šç”»åŒ… (å¸¦å¹³æ»‘ç§»åŠ¨åŠ¨ç”» - Web Animations API ç‰ˆ)
        function drawPacket(parent, x, y, w, h, text, color, opacity=1, isFragment=false, animateFrom=null) {
            const g = createEl("g", {opacity: opacity});
            const rectAttrs = {x:0, y:0, width:w, height:h, fill:color, rx:4};
            
            if(isFragment) {
                rectAttrs["stroke"] = "#fff";
                rectAttrs["stroke-dasharray"] = "4,2";
                rectAttrs["stroke-width"] = 2;
            }
            
            g.appendChild(createEl("rect", rectAttrs));
            const t = createEl("text", {x:w/2, y:h/2+5, "text-anchor":"middle", fill:"#fff", "font-size":12, "font-weight":"bold"});
            t.textContent = text;
            g.appendChild(t);
            
            // è®¾ç½®æœ€ç»ˆä½ç½® (ä½¿ç”¨ SVG å±æ€§ä»¥ä¿è¯å…¼å®¹æ€§)
            g.setAttribute("transform", `translate(${x}, ${y})`);
            
            parent.appendChild(g);

            // å¦‚æœæœ‰èµ·ç‚¹ï¼Œåˆ™æ‰§è¡Œ WAAPI åŠ¨ç”»
            if(animateFrom) {
                try {
                    g.animate([
                        { transform: `translate(${animateFrom.x}px, ${animateFrom.y}px)` },
                        { transform: `translate(${x}px, ${y}px)` }
                    ], {
                        duration: 800,
                        easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)',
                        fill: 'both'
                    });
                } catch(e) {
                    console.error("Animation failed:", e);
                }
            } else {
                g.classList.add("fade-in");
            }
        }

        function drawLabel(parent, x, y, text, color) {
            const t = createEl("text", {x:x, y:y, fill:color, "font-weight":"bold", class:"fade-in", "font-size":14});
            t.textContent = text;
            parent.appendChild(t);
        }

        function drawArrow(parent, x1, y1, x2, y2, text, color="#aaa") {
            const g = createEl("g", {class:"fade-in"});
            g.appendChild(createEl("line", {x1:x1, y1:y1, x2:x2, y2:y2, stroke:color, "stroke-width":2, "marker-end":"url(#arrow)"}));
            if(text) {
                const t = createEl("text", {x:(x1+x2)/2, y:y1-10, "text-anchor":"middle", fill:color, "font-size":12});
                t.textContent = text;
                g.appendChild(t);
            }
            parent.appendChild(g);
        }

        // åˆå§‹åŒ–
        switchMode('qbv');

    </script>
</body>
</html>
