<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSN é…ç½®ä¸æ§åˆ¶å¹³é¢å›¾è§£ (Qcc, Qat, Qca)</title>
    <style>
        :root {
            --bg: #0f111a;
            --panel: #1a1d2d;
            --text: #e0e0e0;
            --primary: #9c27b0; /* ç´«è‰²ç³»ï¼Œä»£è¡¨æ§åˆ¶å¹³é¢ */
            --node-bg: #263238;
            --line: #455a64;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 { color: var(--primary); margin: 10px 0; }
        
        .nav-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid #333;
        }

        .nav-btn {
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.3s;
            color: #aaa;
            font-weight: bold;
        }

        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            gap: 20px;
            flex: 1;
        }

        .diagram-box {
            flex: 2;
            background: radial-gradient(#23263a 1px, transparent 1px);
            background-size: 20px 20px;
            border: 1px solid #333;
            border-radius: 12px;
            position: relative;
            min-height: 500px;
            overflow: hidden;
        }

        .text-box {
            flex: 1;
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .step-list {
            list-style: none;
            padding: 0;
        }

        .step-item {
            padding: 15px;
            border-left: 3px solid #444;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.02);
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-item:hover { background: rgba(255,255,255,0.05); }
        .step-item.active { border-left-color: var(--primary); background: rgba(156, 39, 176, 0.1); }

        .step-title { font-weight: bold; margin-bottom: 5px; color: #fff; }
        .step-desc { font-size: 13px; color: #aaa; line-height: 1.5; }

        /* SVG Elements */
        text { font-family: sans-serif; fill: #e0e0e0; }
        .node-rect { fill: var(--node-bg); stroke: #aaa; stroke-width: 2; rx: 8; }
        .msg-line { stroke: var(--primary); stroke-width: 2; stroke-dasharray: 5,5; }
        .anim-packet { fill: var(--primary); }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #aaa;
            text-decoration: none;
            font-size: 14px;
        }
        .back-link:hover { color: #fff; }

    </style>
</head>
<body>

    <a href="tsn_control.html" class="back-link">â†© è¿”å›æ€»è§ˆ</a>

    <h1>TSN æ§åˆ¶å¹³é¢è¯¦è§£</h1>
    <div style="color:#888; margin-bottom:20px;">å¦‚ä½•é…ç½®å’Œç®¡ç† TSN ç½‘ç»œ (802.1Qcc, Qat, Qca)</div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="setMode('qcc')">802.1Qcc (CNC)</div>
        <div class="nav-btn" onclick="setMode('qat')">802.1Qat (SRP)</div>
        <div class="nav-btn" onclick="setMode('qca')">802.1Qca (Path)</div>
        <div class="nav-btn" onclick="setMode('summary')" style="border-color:var(--primary); color:var(--primary)">ğŸ†š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”</div>
    </div>

    <div class="container">
        <div class="diagram-box" id="diagram">
            <!-- SVG will be injected here -->
        </div>
        
        <div class="text-box">
            <h2 id="modeTitle">é›†ä¸­å¼ç½‘ç»œé…ç½® (CNC)</h2>
            <div id="modeDesc" style="margin-bottom:20px; color:#aaa; font-size:14px;">
                TSN çš„å¤§è„‘ã€‚ç”¨æˆ·é€šè¿‡ CUC æäº¤éœ€æ±‚ï¼ŒCNC è®¡ç®—è·¯å¾„å’Œè°ƒåº¦è¡¨ï¼Œç„¶åç»Ÿä¸€ä¸‹å‘ç»™äº¤æ¢æœºã€‚
            </div>
            <div class="step-list" id="stepList">
                <!-- Steps will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const DATA = {
            qcc: {
                title: "802.1Qcc - é›†ä¸­å¼é…ç½® (CNC) [åœºæ™¯ï¼šAGV å°è½¦è§†é¢‘å›ä¼ ]",
                desc: "<b>åœºæ™¯èƒŒæ™¯ï¼š</b> å·¥å‚é‡Œçš„ä¸€å° AGV å°è½¦ (Talker) éœ€è¦æŠŠé«˜æ¸…æ‘„åƒå¤´ç”»é¢å®æ—¶ä¼ å›ä¸­æ§å®¤å±å¹• (Listener)ï¼Œä»¥ä¾¿è¿œç¨‹ç›‘æ§ã€‚å¦‚æœç½‘ç»œå¡é¡¿ï¼Œå°è½¦å¯èƒ½ä¼šæ’äººã€‚æˆ‘ä»¬éœ€è¦ CNC æ¥ç¡®ä¿è¿™æ®µè§†é¢‘æµç»å¯¹æµç•…ã€‚",
                talkerLabel: "AGV Camera",
                listenerLabel: "Control Monitor",
                steps: [
                    {
                        t: "1. æéœ€æ±‚ï¼šæˆ‘è¦å‘è§†é¢‘ï¼",
                        d: "AGV å°è½¦é€šè¿‡ CUC å‘Šè¯‰ CNCï¼š<br>â€œæˆ‘æ˜¯ AGV-01ï¼Œæˆ‘è¦ç»™ä¸­æ§å®¤å‘ä¸€ä¸ªè§†é¢‘æµã€‚<br><b>å¸¦å®½ï¼š</b>50Mbps (4Kç”»é¢)<br><b>å»¶è¿Ÿï¼š</b>å¿…é¡»å°äº 2ms (ä¸ç„¶åˆ¹ä¸ä½è½¦)â€",
                        anim: (svg) => drawMsg(svg, 130, 300, 400, 120, "Req: 4K Video, <2ms")
                    },
                    {
                        t: "2. ç®—è·¯å¾„ï¼šCNC çš„ä¸Šå¸è§†è§’",
                        d: "CNC æ‹¿å‡ºå·¥å‚ç½‘ç»œåœ°å›¾ï¼Œå¼€å§‹è®¡ç®—ï¼š<br>â€œä» AGV åˆ°ä¸­æ§å®¤ï¼Œèµ° SW1 -> SW2 æœ€å¿«ã€‚<br>ä½†æ˜¯ SW1 æ­¤æ—¶æ‹¥å µï¼Œæˆ‘éœ€è¦ç»™è¿™ä¸ªè§†é¢‘æµå®‰æ’ä¸€ä¸ª<b>VIP ç»¿è‰²é€šé“ (GCL)</b>ã€‚â€",
                        anim: (svg) => {
                            highlightPath(svg);
                            drawLabel(svg, 400, 30, "Planning: GCL Schedule...", "yellow");
                        }
                    },
                    {
                        t: "3. ä¸‹é…ç½®ï¼šå…¨ç½‘åŒæ­¥",
                        d: "CNC åƒæŒ‡æŒ¥å®˜ä¸€æ ·ï¼Œå‘æ²¿é€”çš„ SW1 å’Œ SW2 ä¸‹è¾¾æŒ‡ä»¤ï¼š<br>â€œåœ¨æ¯ç§’çš„ç¬¬ 0-10msï¼ŒæŠŠæ‰€æœ‰è·¯å£éƒ½å°æ­»ï¼Œåªå‡† AGV çš„è§†é¢‘æµé€šè¿‡ï¼â€<br>äº¤æ¢æœºæ”¶åˆ°é…ç½®å¹¶ç”Ÿæ•ˆã€‚",
                        anim: (svg) => {
                            drawMsg(svg, 400, 120, 250, 240, "GCL: Open for AGV");
                            drawMsg(svg, 400, 120, 550, 240, "GCL: Open for AGV");
                        }
                    },
                    {
                        t: "4. å¼€æ’­ï¼šç•…é€šæ— é˜»",
                        d: "é…ç½®å®Œæˆï¼ŒCNC é€šçŸ¥ AGV â€œè·¯é“ºå¥½äº†â€ã€‚<br>AGV å¼€å§‹æ¨æµï¼Œè§†é¢‘æ•°æ®åœ¨é¢„ç•™çš„â€œç»¿è‰²é€šé“â€ä¸­æé€Ÿé£é©°ï¼Œæ¯«æ— å¡é¡¿åœ°æ˜¾ç¤ºåœ¨ä¸­æ§å®¤å±å¹•ä¸Šã€‚",
                        anim: (svg) => drawStream(svg)
                    }
                ]
            },
            qat: {
                title: "802.1Qat - æµé¢„ç•™åè®® (SRP)",
                desc: "æ—©æœŸçš„åˆ†å¸ƒå¼é…ç½®åè®®ã€‚è®¾å¤‡è‡ªå·±å–Šè¯â€œæˆ‘è¦å‘æ•°æ®â€ï¼Œäº¤æ¢æœºé€è·³åå•†èµ„æºã€‚ä¸éœ€è¦ä¸­å¤®æ§åˆ¶å™¨ï¼Œé€‚åˆç®€å•ç½‘ç»œï¼Œä½†éš¾ä»¥åšå¤æ‚çš„å…¨å±€è°ƒåº¦ã€‚",
                steps: [
                    {
                        t: "1. Talker Advertise (æˆ‘ä»¥æ­¤æµå‚æ•°å‘é€)",
                        d: "Talker å¹¿æ’­ä¸€ä¸ª <b>Talker Advertise</b> æ¶ˆæ¯ï¼ŒåŒ…å«æµ ID å’Œæµé‡å‚æ•° (T-Spec)ã€‚<br>æ¶ˆæ¯åœ¨ç½‘ç»œä¸­æ³›æ´ªæˆ–æ²¿è·¯å¾„ä¼ æ’­ã€‚",
                        anim: (svg) => drawMsg(svg, 130, 300, 250, 240, "Talker Adv")
                    },
                    {
                        t: "2. Listener Join (æˆ‘è¦å¬è¿™ä¸ªæµ)",
                        d: "Listener æ”¶åˆ°å¹¿æ’­åï¼Œå¦‚æœæƒ³æ¥æ”¶ï¼Œå°±å›å¤ä¸€ä¸ª <b>Listener Ready</b> æ¶ˆæ¯ã€‚<br>è¯¥æ¶ˆæ¯æ²¿åŸè·¯è¿”å›ï¼Œé€è·³ç¡®è®¤èµ„æºã€‚",
                        anim: (svg) => drawMsg(svg, 670, 300, 550, 240, "Listener Ready")
                    },
                    {
                        t: "3. èµ„æºé”å®š (Resource Reservation)",
                        d: "æ²¿é€”äº¤æ¢æœºæ”¶åˆ° Ready æ¶ˆæ¯åï¼Œæ£€æŸ¥å¸¦å®½æ˜¯å¦è¶³å¤Ÿã€‚å¦‚æœè¶³å¤Ÿï¼Œå°±é”å®šèµ„æºï¼ˆé¢„ç•™å¸¦å®½ï¼‰ï¼Œå¹¶å‘ä¸Šä¼ é€’ã€‚",
                        anim: (svg) => {
                            drawLabel(svg, 250, 350, "Reserve BW", "#4caf50");
                            drawLabel(svg, 550, 350, "Reserve BW", "#4caf50");
                            drawMsg(svg, 550, 240, 250, 240, "Ready Propagates");
                        }
                    },
                    {
                        t: "4. å»ºç«‹å®Œæˆ",
                        d: "Talker æ”¶åˆ°æœ€ç»ˆçš„ Ready æ¶ˆæ¯ï¼Œç¡®è®¤è·¯å¾„å·²æ‰“é€šï¼Œå¼€å§‹å‘é€æ•°æ®ã€‚",
                        anim: (svg) => drawStream(svg)
                    }
                ]
            },
            qca: {
                title: "802.1Qca - è·¯å¾„æ§åˆ¶ä¸é¢„ç•™ (PCR) [åœºæ™¯ï¼šåŒ–å·¥å‚ç´§æ€¥åœæœº]",
                desc: "<b>åœºæ™¯èƒŒæ™¯ï¼š</b> åŒ–å·¥å‚çš„å‹åŠ›ä¼ æ„Ÿå™¨ (Talker) ç›‘æµ‹åˆ°å¼‚å¸¸ï¼Œå¿…é¡»ç«‹å³å‘é€â€œåœæœºæŒ‡ä»¤â€ç»™é˜€é—¨ (Listener)ã€‚<br>ä¸ºäº†ä¸‡æ— ä¸€å¤±ï¼Œæˆ‘ä»¬ä¸èƒ½åªèµ°ä¸€æ¡è·¯ï¼ˆä¸‡ä¸€æ–­äº†å‘¢ï¼Ÿï¼‰ã€‚<br>Qca çš„ä»»åŠ¡å°±æ˜¯å»ºç«‹<b>ä¸¤æ¡å®Œå…¨ä¸é‡åˆ</b>çš„æ˜¾å¼è·¯å¾„ (Explicit Paths)ï¼Œé…åˆ FRER å®ç°åŒå‘é€‰æ”¶ã€‚",
                talkerLabel: "Sensor",
                listenerLabel: "Valve",
                steps: [
                    {
                        t: "1. æ‹“æ‰‘å‘ç° (IS-IS åè®®)",
                        d: "Qca æ‰©å±•äº† IS-IS è·¯ç”±åè®®ã€‚äº¤æ¢æœºä¹‹é—´äº’ç›¸å‘é€ Hello åŒ…ï¼Œäº¤æ¢é“¾è·¯çŠ¶æ€ä¿¡æ¯ã€‚<br>æœ€ç»ˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ PCE è®¡ç®—å•å…ƒï¼‰éƒ½æ‹¥æœ‰äº†ä¸€å¼ å®Œæ•´çš„<b>å…¨ç½‘åœ°å›¾</b>ã€‚",
                        anim: (svg) => drawPulse(svg)
                    },
                    {
                        t: "2. æ™ºèƒ½ç®—è·¯ (PCE)",
                        d: "è·¯å¾„è®¡ç®—å•å…ƒ (PCE) ä»‹å…¥ã€‚å®ƒä¸ä»…ä»…æ‰¾â€œæœ€çŸ­è·¯å¾„â€ï¼Œè€Œæ˜¯è¦æ‰¾â€œä¸¤æ¡æœ€ä¸ç›¸å…³çš„è·¯å¾„â€ã€‚<br><b>ç›®æ ‡ï¼š</b>è·¯å¾„ A å’Œ è·¯å¾„ B å°½é‡ä¸ç»è¿‡åŒä¸€ä¸ªä¸­é—´äº¤æ¢æœºï¼Œé˜²æ­¢å•ç‚¹æ•…éšœã€‚",
                        anim: (svg) => {
                             // ç»˜åˆ¶è®¡ç®—è¿‡ç¨‹
                             drawLabel(svg, 400, 80, "PCE Calculating Disjoint Paths...", "yellow");
                             drawPath(svg, [130, 210, 510, 670], 300, "Path A (Primary)", "var(--primary)"); // Straight
                             drawPath(svg, [130, 210, 360, 510, 670], 400, "Path B (Redundant)", "#ff9800"); // Curve
                        }
                    },
                    {
                        t: "3. é”å®šæ˜¾å¼æ ‘ (Explicit Tree)",
                        d: "è®¡ç®—å®Œæˆåï¼ŒQca å°†è¿™ä¸¤æ¡è·¯å¾„è½¬åŒ–ä¸ºâ€œæ˜¾å¼æ ‘â€ä¿¡æ¯ï¼Œä¸‹å‘ç»™äº¤æ¢æœºã€‚<br>äº¤æ¢æœºé”å®š FDB è¡¨é¡¹ï¼š<br>â€¢ æ”¶åˆ° ID=X çš„åŒ…ï¼Œå¤åˆ¶ä¸¤ä»½ã€‚<br>â€¢ ä¸€ä»½èµ° Path Aï¼Œä¸€ä»½èµ° Path Bã€‚",
                        anim: (svg) => {
                             drawLabel(svg, 210, 240, "Lock: Split", "var(--success)");
                             drawLabel(svg, 510, 240, "Lock: Merge", "var(--success)");
                        }
                    },
                    {
                        t: "4. åŒè·¯ä¼ è¾“ (FRER ç”Ÿæ•ˆ)",
                        d: "ä¼ æ„Ÿå™¨å‘å‡ºâ€œåœæœºæŒ‡ä»¤â€ã€‚<br>æŒ‡ä»¤åœ¨ SW1 è¢«å¤åˆ¶ï¼Œæ²¿ç€ä¸¤æ¡è·¯ç‹‚å¥”ã€‚<br>å³ä½¿ Path A çš„çº¿ç¼†è¢«æŒ–æ–­ï¼ŒPath B çš„æŒ‡ä»¤ä¾ç„¶èƒ½åˆ°è¾¾é˜€é—¨ï¼Œç¡®ä¿å®‰å…¨ã€‚",
                        anim: (svg) => {
                            // Path A Packet
                            const c1 = createSvgEl("circle", {r:6, fill:"var(--primary)"});
                            c1.appendChild(createSvgEl("animateMotion", {path: "M 130 300 L 670 300", dur: "2s", repeatCount: "indefinite"}));
                            svg.appendChild(c1);
                            
                            // Path B Packet (Curved)
                            const c2 = createSvgEl("circle", {r:6, fill:"#ff9800"});
                            // Simple curve path
                            const d = "M 130 300 L 210 300 Q 360 450 510 300 L 670 300";
                            c2.appendChild(createSvgEl("animateMotion", {path: d, dur: "2s", repeatCount: "indefinite"}));
                            svg.appendChild(c2);
                            
                            // Cut event
                            setTimeout(() => {
                                drawLabel(svg, 360, 290, "âš¡ Link Fail!", "#f44336");
                            }, 1000);
                        }
                    }
                ]
            },
            summary: {
                title: "æ ¸å¿ƒå·®å¼‚å¯¹æ¯”ï¼šQcc vs Qat vs Qca",
                desc: "é€šè¿‡å¯¹æ¯”ï¼Œé€‰æ‹©æœ€é€‚åˆæ‚¨ä¸šåŠ¡éœ€æ±‚çš„æ§åˆ¶å¹³é¢æ–¹æ¡ˆã€‚",
                steps: [
                    {
                        t: "1. æ¶æ„æ€»è§ˆ (Architecture)",
                        d: "å·¦å›¾å¹¶åˆ—å±•ç¤ºäº†ä¸‰ç§åè®®çš„æ§åˆ¶é€»è¾‘å·®å¼‚ã€‚<br>è¯·ç‚¹å‡»ä¸‹æ–¹ <b>â€œä¸‹ä¸€æ­¥â€</b> æŒ‰é’®ï¼Œæˆ‘ä»¬å°†é€ä¸€å‰–æå®ƒä»¬çš„ä¼˜ç¼ºç‚¹ã€‚",
                        anim: (svg) => drawSummaryDiagram(svg, 'all')
                    },
                    {
                        t: "2. Qat (SRP): åˆ†å¸ƒå¼åå•†",
                        d: "<b>ç‰¹ç‚¹ï¼š</b> åƒä¼ è¯æ¸¸æˆï¼ŒTalker å‘èµ·ï¼Œäº¤æ¢æœºé€è·³é—®è¯¢ã€‚<br><b>âœ… ä¼˜ç‚¹ï¼š</b> ç®€å•ã€å»ä¸­å¿ƒåŒ–ã€å³æ’å³ç”¨ã€‚<br><b>âŒ ç¼ºç‚¹ï¼š</b> åªæœ‰å±€éƒ¨è§†é‡ï¼Œæ— æ³•å®ç°å…¨å±€æœ€ä¼˜è°ƒåº¦ (å®¹æ˜“èµ„æºç¢ç‰‡åŒ–)ã€‚<br><b>ğŸ¯ é€‚ç”¨ï¼š</b> éŸ³è§†é¢‘æµ (AVB)ï¼Œå¯¹è°ƒåº¦ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚",
                        anim: (svg) => drawSummaryDiagram(svg, 'qat')
                    },
                    {
                        t: "3. Qcc (CNC): é›†ä¸­å¼æ§åˆ¶",
                        d: "<b>ç‰¹ç‚¹ï¼š</b> åƒå¡”å°æŒ‡æŒ¥ï¼ŒCNC æŒæ¡å…¨å±€åœ°å›¾ï¼Œç»Ÿä¸€å‘å·æ–½ä»¤ã€‚<br><b>âœ… ä¼˜ç‚¹ï¼š</b> ä¸Šå¸è§†è§’ï¼Œèƒ½è®¡ç®—å¾®ç§’çº§ç²¾åº¦çš„ GCLï¼Œèµ„æºåˆ©ç”¨ç‡æœ€é«˜ã€‚<br><b>âŒ ç¼ºç‚¹ï¼š</b> ç³»ç»Ÿå¤æ‚ï¼Œæˆæœ¬é«˜ï¼ŒCNC æ˜¯å•ç‚¹æ•…éšœé£é™©ã€‚<br><b>ğŸ¯ é€‚ç”¨ï¼š</b> å·¥ä¸šè‡ªåŠ¨åŒ–ã€è½¦è½½éª¨å¹²ç½‘ (éœ€è¦ Qbv çš„åœºæ™¯)ã€‚",
                        anim: (svg) => drawSummaryDiagram(svg, 'qcc')
                    },
                    {
                        t: "4. Qca (PCR): æ˜¾å¼è·¯å¾„",
                        d: "<b>ç‰¹ç‚¹ï¼š</b> åƒå¯¼èˆªè½¯ä»¶ï¼Œå¼ºåˆ¶æŒ‡å®šâ€œæ€ä¹ˆèµ°â€ã€‚<br><b>âœ… ä¼˜ç‚¹ï¼š</b> èƒ½å»ºç«‹ä¸ç›¸äº¤çš„å¤šæ¡è·¯å¾„ (Disjoint Paths)ï¼Œè§£å†³ç¯è·¯é—®é¢˜ã€‚<br><b>âŒ ç¼ºç‚¹ï¼š</b> åè®®æ ˆå¤æ‚ (IS-IS æ‰©å±•)ã€‚<br><b>ğŸ¯ é€‚ç”¨ï¼š</b> é«˜å¯é æ€§å†—ä½™ä¼ è¾“ (é…åˆ FRER ä½¿ç”¨)ã€‚",
                        anim: (svg) => drawSummaryDiagram(svg, 'qca')
                    }
                ]
            }
        };

        let currentMode = 'qcc';
        let currentStep = 0;

        function setMode(mode) {
            currentMode = mode;
            currentStep = 0;
            
            // UI Update
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                if(b.textContent.toLowerCase().includes(mode)) b.classList.add('active');
            });
            
            document.getElementById('modeTitle').textContent = DATA[mode].title;
            document.getElementById('modeDesc').innerHTML = DATA[mode].desc;
            
            renderSteps();
            drawBase();
        }

        function renderSteps() {
            const list = document.getElementById('stepList');
            list.innerHTML = '';
            DATA[currentMode].steps.forEach((s, i) => {
                const li = document.createElement('li');
                li.className = `step-item ${i === currentStep ? 'active' : ''}`;
                li.innerHTML = `<div class="step-title">${s.t}</div><div class="step-desc">${s.d}</div>`;
                li.onclick = () => { currentStep = i; renderSteps(); drawBase(); s.anim(document.getElementById('svgRoot')); };
                list.appendChild(li);
            });
            
            // Auto trigger animation for current step
            setTimeout(() => {
                DATA[currentMode].steps[currentStep].anim(document.getElementById('svgRoot'));
            }, 100);
        }

        function createSvgEl(type, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", type);
            for(let k in attrs) el.setAttribute(k, attrs[k]);
            return el;
        }

        function drawBase() {
            const container = document.getElementById('diagram');
            container.innerHTML = '';
            
            const svg = createSvgEl("svg", {width: "100%", height: "100%", viewBox: "0 0 800 500", id: "svgRoot"});
            container.appendChild(svg);
            
            if(currentMode === 'summary') return; // Summary æ¨¡å¼ç”± anim å‡½æ•°å®Œå…¨æ¥ç®¡ç»˜å›¾

            // Nodes
            // CNC (Top)
            if(currentMode === 'qcc') {
                svg.appendChild(createSvgEl("rect", {x:350, y:50, width:100, height:60, class:"node-rect", fill:"#37474f"}));
                const t = createSvgEl("text", {x:400, y:85, "text-anchor":"middle", "font-weight":"bold"});
                t.textContent = "CNC";
                svg.appendChild(t);
            }

            // Talker (Left)
            svg.appendChild(createSvgEl("rect", {x:50, y:270, width:80, height:60, class:"node-rect"}));
            const t1 = createSvgEl("text", {x:90, y:305, "text-anchor":"middle"}); 
            t1.textContent = DATA[currentMode].talkerLabel || "Talker"; 
            svg.appendChild(t1);

            // Listener (Right)
            svg.appendChild(createSvgEl("rect", {x:670, y:270, width:80, height:60, class:"node-rect"}));
            const t2 = createSvgEl("text", {x:710, y:305, "text-anchor":"middle"}); 
            t2.textContent = DATA[currentMode].listenerLabel || "Listener"; 
            svg.appendChild(t2);

            // Switches
            const drawSw = (x, y, label) => {
                svg.appendChild(createSvgEl("rect", {x:x, y:y, width:80, height:60, class:"node-rect"}));
                const t = createSvgEl("text", {x:x+40, y:y+35, "text-anchor":"middle"});
                t.textContent = label;
                svg.appendChild(t);
            };

            drawSw(210, 270, "SW1");
            drawSw(510, 270, "SW2");
            
            // Links
            const drawLink = (x1, y1, x2, y2) => {
                svg.appendChild(createSvgEl("line", {x1:x1, y1:y1, x2:x2, y2:y2, stroke:"#555", "stroke-width":4}));
            };
            
            drawLink(130, 300, 210, 300); // Talker -> SW1
            drawLink(290, 300, 510, 300); // SW1 -> SW2
            drawLink(590, 300, 670, 300); // SW2 -> Listener

            // Config Links (Dashed)
            if(currentMode === 'qcc') {
                 // CNC -> Switches
                 svg.appendChild(createSvgEl("path", {d:"M 400 110 L 250 270", stroke:"#555", "stroke-dasharray":"5,5"}));
                 svg.appendChild(createSvgEl("path", {d:"M 400 110 L 550 270", stroke:"#555", "stroke-dasharray":"5,5"}));
                 // Talker -> CUC -> CNC (Simplified)
                 svg.appendChild(createSvgEl("path", {d:"M 90 270 L 90 80 L 350 80", stroke:"#555", "stroke-dasharray":"5,5"}));
                 const tCuc = createSvgEl("text", {x:90, y:70, "text-anchor":"middle", fill:"#aaa"}); tCuc.textContent = "CUC"; svg.appendChild(tCuc);
            }
        }

        // Animations
        function drawMsg(svg, x1, y1, x2, y2, text) {
            const g = createSvgEl("g");
            const circle = createSvgEl("circle", {cx:x1, cy:y1, r:8, fill:"var(--primary)"});
            g.appendChild(circle);
            
            const anim = createSvgEl("animate", {
                attributeName: "cx", from: x1, to: x2, dur: "1s", fill: "freeze", begin: "0s"
            });
            const animY = createSvgEl("animate", {
                attributeName: "cy", from: y1, to: y2, dur: "1s", fill: "freeze", begin: "0s"
            });
            circle.appendChild(anim);
            circle.appendChild(animY);
            
            // Label moving with it
            const t = createSvgEl("text", {x:x1, y:y1-15, "text-anchor":"middle", fill:"var(--primary)", "font-weight":"bold"});
            t.textContent = text;
            const animTx = createSvgEl("animate", {
                attributeName: "x", from: x1, to: x2, dur: "1s", fill: "freeze", begin: "0s"
            });
            const animTy = createSvgEl("animate", {
                attributeName: "y", from: y1-15, to: y2-15, dur: "1s", fill: "freeze", begin: "0s"
            });
            t.appendChild(animTx);
            t.appendChild(animTy);
            g.appendChild(t);
            
            svg.appendChild(g);
        }

        function highlightPath(svg) {
            const p = createSvgEl("path", {
                d: "M 130 300 L 670 300", 
                stroke: "var(--primary)", "stroke-width": 6, "stroke-opacity": 0.3, fill: "none"
            });
            svg.appendChild(p);
        }

        function drawStream(svg) {
            highlightPath(svg);
            // Multiple packets
            for(let i=0; i<3; i++) {
                const c = createSvgEl("circle", {r:6, fill:"#fff"});
                const anim = createSvgEl("animateMotion", {
                    path: "M 130 300 L 670 300",
                    dur: "2s",
                    begin: `${i*0.5}s`,
                    repeatCount: "indefinite"
                });
                c.appendChild(anim);
                svg.appendChild(c);
            }
        }

        function drawLabel(svg, x, y, text, color) {
            const t = createSvgEl("text", {x:x, y:y, "text-anchor":"middle", fill:color, "font-weight":"bold"});
            t.textContent = text;
            svg.appendChild(t);
        }

        function drawPulse(svg) {
             [250, 550].forEach(x => {
                 const c = createSvgEl("circle", {cx:x, cy:300, r:10, fill:"none", stroke:"var(--primary)", "stroke-width":2});
                 const anim = createSvgEl("animate", {attributeName:"r", from:10, to:50, dur:"1s", repeatCount:"indefinite"});
                 const op = createSvgEl("animate", {attributeName:"opacity", from:1, to:0, dur:"1s", repeatCount:"indefinite"});
                 c.appendChild(anim);
                 c.appendChild(op);
                 svg.appendChild(c);
             });
        }
        
        function drawPath(svg, xCoords, y, label, color) {
            let d = `M ${xCoords[0]} ${y}`;
            for(let i=1; i<xCoords.length; i++) d += ` L ${xCoords[i]} ${y}`;
            
            // Just visualization, curve it if needed
            if(y !== 300) {
                // simple curve logic for backup path
                d = `M 130 300 Q 400 ${y} 670 300`;
            } else {
                d = "M 130 300 L 670 300";
            }

            const p = createSvgEl("path", {d:d, stroke:color, "stroke-width":4, fill:"none", "stroke-dasharray":"5,5"});
            svg.appendChild(p);
            
            const t = createSvgEl("text", {x:400, y:y, fill:color, "text-anchor":"middle", "font-weight":"bold"});
            t.textContent = label;
            svg.appendChild(t);
        }

        function drawSummaryDiagram(svg, highlightMode='all') {
            // highlightMode: 'all' | 'qat' | 'qcc' | 'qca'
            
            // Helper to determine opacity
            const getOp = (mode) => (highlightMode === 'all' || highlightMode === mode) ? 1 : 0.2;

            // 1. Qat (Distributed)
            const g1 = createSvgEl("g", {opacity: getOp('qat')});
            g1.appendChild(createSvgEl("rect", {x:50, y:50, width:200, height:300, fill:"#1e2230", stroke:"#444", rx:8}));
            const t1 = createSvgEl("text", {x:150, y:80, "text-anchor":"middle", fill:"#fff", "font-weight":"bold"});
            t1.textContent = "Qat (åˆ†å¸ƒå¼)";
            g1.appendChild(t1);
            
            // Nodes talking
            drawMiniNode(g1, 100, 150, "A");
            drawMiniNode(g1, 200, 150, "B");
            drawMiniNode(g1, 150, 250, "C");
            g1.appendChild(createSvgEl("path", {d:"M 110 160 L 190 160 M 110 160 L 150 240", stroke:"#aaa", "stroke-dasharray":"3,3"}));
            
            const d1 = createSvgEl("text", {x:150, y:320, "text-anchor":"middle", fill:"#aaa", "font-size":12});
            d1.textContent = "èŠ‚ç‚¹åå•† (P2P)";
            g1.appendChild(d1);
            svg.appendChild(g1);

            // 2. Qcc (Centralized)
            const g2 = createSvgEl("g", {opacity: getOp('qcc')});
            g2.appendChild(createSvgEl("rect", {x:280, y:50, width:200, height:300, fill:"#1e2230", stroke:"var(--primary)", "stroke-width":2, rx:8}));
            const t2 = createSvgEl("text", {x:380, y:80, "text-anchor":"middle", fill:"var(--primary)", "font-weight":"bold"});
            t2.textContent = "Qcc (é›†ä¸­å¼)";
            g2.appendChild(t2);
            
            // CNC controlling
            drawMiniNode(g2, 380, 120, "CNC");
            drawMiniNode(g2, 330, 250, "SW1");
            drawMiniNode(g2, 430, 250, "SW2");
            g2.appendChild(createSvgEl("path", {d:"M 380 130 L 330 240 M 380 130 L 430 240", stroke:"var(--primary)", "stroke-width":2}));
            
            const d2 = createSvgEl("text", {x:380, y:320, "text-anchor":"middle", fill:"#aaa", "font-size":12});
            d2.textContent = "ä¸Šå¸è§†è§’ (Global)";
            g2.appendChild(d2);
            svg.appendChild(g2);

            // 3. Qca (Path)
            const g3 = createSvgEl("g", {opacity: getOp('qca')});
            g3.appendChild(createSvgEl("rect", {x:510, y:50, width:200, height:300, fill:"#1e2230", stroke:"#444", rx:8}));
            const t3 = createSvgEl("text", {x:610, y:80, "text-anchor":"middle", fill:"#ff9800", "font-weight":"bold"});
            t3.textContent = "Qca (æ˜¾å¼è·¯å¾„)";
            g3.appendChild(t3);
            
            // Multiple paths
            drawMiniNode(g3, 560, 150, "In");
            drawMiniNode(g3, 660, 150, "Out");
            g3.appendChild(createSvgEl("path", {d:"M 560 160 Q 610 100 660 160", stroke:"var(--primary)", "stroke-width":2, fill:"none"}));
            g3.appendChild(createSvgEl("path", {d:"M 560 160 Q 610 300 660 160", stroke:"#ff9800", "stroke-width":2, fill:"none"}));
            
            const d3 = createSvgEl("text", {x:610, y:320, "text-anchor":"middle", fill:"#aaa", "font-size":12});
            d3.textContent = "å¤šè·¯å¾„æ§åˆ¶ (Explicit)";
            g3.appendChild(d3);
            svg.appendChild(g3);
        }

        function drawMiniNode(parent, x, y, label) {
            parent.appendChild(createSvgEl("circle", {cx:x, cy:y, r:15, fill:"#37474f", stroke:"#aaa"}));
            const t = createSvgEl("text", {x:x, y:y+4, "text-anchor":"middle", fill:"#fff", "font-size":10});
            t.textContent = label;
            parent.appendChild(t);
        }

        // Init
        setMode('qcc');

    </script>
</body>
</html>